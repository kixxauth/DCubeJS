<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr" id="html">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>DCube_libJS Test Suite</title>
	<link rel="Stylesheet" media="screen" type="text/css"
				href="http://github.com/jquery/qunit/raw/master/qunit/qunit.css" />

	<style type="text/css">
		#setup {
			padding: 1em;
		}
		.setup-label {
			margin: 0 0.5em 0 2em;
		}
		#gobutton {
			margin: 1em;
		}
	</style>
	<script type="text/javascript" src="http://github.com/jquery/qunit/raw/master/qunit/qunit.js"></script>
	<script type="text/javascript">

stop();

// Require
function require(id) {
  var m = Components.utils.import(
      "resource://chrometest/resources/"+ id +".js", null);
  return ((typeof m.exports === "object") ? m.exports : m);
}

function run_tests() {
	var ddd = require("dcube");
	var username = document.getElementById("username").value;
	var passkey = document.getElementById("passkey").value;

	dump("\n\n <-- start testing -->\n");
	start();

	test("import", 1, function () {
		equals(typeof ddd, "object", "imported module");
	});

	test("debug mode", 1, function () {
		ok(ddd.debug(true) === ddd, ".debug() is chainable");
	});

	test("domain accessor", 1, function () {
		ok(ddd.domain("fireworks-skylight.appspot.com") === ddd, ".domain() is chainable");
	});

	test("invalid usernames", 6, function () {
		try {
			ddd.user("");
		} catch (e) {
			ok(e.constructor === ddd.stringException, "raised string exception");
			equals(e.name, "usernameValidationError", "username validation error");
			equals(e.message, "too short", "username too short");
		}

		try {
			ddd.user("foo bar");
		} catch (e) {
			ok(e.constructor === ddd.stringException, "raised string exception");
			equals(e.name, "usernameValidationError", "username validation error");
			equals(e.message, "invalid characters", "invalid chars");
		}
	});

	test(".userExists() void", 1, function () {
		var cb, eb, pr;
		stop();

		cb = function (x) {
			equals(x, false, "the user does not exist.");
			start();
		}

		eb = function (x) {
			ok(false, "exception: "+ x);
			start();
		}

		ddd.userExists("foo")(cb, eb);
	});

	test(".userExists() exists", 1, function () {
		var cb, eb, pr;
		stop();

		cb = function (x) {
			equals(x, true, "the user exists.");
			start();
		}

		eb = function (x) {
			ok(false, x +"");
			start();
		}

		ddd.userExists(username)(cb, eb);
	});

	test(".createUser() ok", 5, function () {
		stop();
		var cb, eb, pr;

		cb = function (x) {
			equals(x.username, "foo", "got username");
			same(x.groups, ["users"], "got groups");
			start();
		}

		eb = function (x) {
			ok(false, "exception: "+ x);
			start();
		}

		pr = function (x) {
			ok((x === "creating" || x === "checking cache" || x === "getting"),
				"progress report: "+ x);
		}

		ddd.createUser("foo", "foobar")(cb, eb, pr);
	});

	test("user.createDatabase() denied", 1, function () {
		stop();
		ddd.user("foo").createDatabase("foobox")(
			function (x) {
				ok(false, "should not succeed");
				start();
			},
			function (x) {
				equals(x.toString(), "DCubeUserError: forbidden", "forbidden: "+ x);
				start();
			});
	});

	test("user.get() user.update() ok", 2, function () {
		stop();
		function cb(user) {
			same(user.groups, ["users"], "got groups");
			user.groups.push("database");
			ddd.user(username).update("foo", user)(
				function (x) {
					same(user.groups, ["users", "database"], "got new groups");
					start();
				},
				function (x) {
					ok(false, "exception: "+ x);
					start();
				});
		}
		function eb(ex) {
			ok(false, "exception: "+ ex);
			start();
		}
		ddd.user(username, passkey).get("foo")(cb, eb);
	});

	test("user.createDatabase() ok", 1, function () {
		stop();
		ddd.user("foo").createDatabase("foobox")(
			function (x) {
				equals(x.name, "foobox", "created db");
				start();
			},
			function (x) {
				ok(false, "exception: "+ x);
				start();
			});
	});

	test("user.getDatabase(); user.updateDatabase()", 6, function () {
		stop();
		ddd.user("foo").getDatabase("foobox")(
			function (x) {
				equals(x.name, "foobox", "got name");
				same(x.owner_acl, ["foo"], "got owner_acl");
				same(x.manager_acl, [], "got manager_acl");
				x.manager_acl.push("johndoe");
				ddd.user("foo").updateDatabase("foobox", x)(
					function (x) {
						equals(x.name, "foobox", "got name");
						same(x.owner_acl, ["foo"], "got owner_acl");
						same(x.manager_acl, ["johndoe"], "got manager_acl");
						start();
					},
					function (x) {
						ok(false, "update exception: "+ x);
						start();
					});
			},
			function (x) {
				ok(false, "get exception: "+ x);
				start();
			});
	});

	test("user.removeDatabase() ok", 1, function () {
		stop();
		ddd.user(username).removeDatabase("foobox")(
			function (x) {
				ok(x, "database removed");
				start();
			},
			function (x) {
				ok(false, "exception: "+ x);
				start();
			});
	});

	test("user.remove()", 1, function () {
		stop();

		function cb(x) {
			ok(x, "user removed");
			start();
		}

		function eb(x) {
			ok(false, x +"");
			start();
		}

		ddd.user("foo").remove()(cb, eb);
	});

	test(".userExists() removed", 1, function () {
		var cb, eb, pr;
		stop();

		cb = function (x) {
			equals(x, false, "the user does not exist.");
			start();
		}

		eb = function (x) {
			ok(false, "exception: "+ x);
			start();
		}

		ddd.userExists("foo")(cb, eb);
	});

}

	</script>
</head>

<body id="body">
	<h1 id="qunit-header">DCube_libJS Test Suite</h1>
	<h2 id="qunit-banner"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<div id="setup">
		<label class="setup-label">username:</label><input id="username" type="text">
		<label class="setup-label">passkey:</label><input id="passkey" type="password">
		<button id="gobutton" onclick="run_tests();">RUN</button>
	</div>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
</body>
</html>
